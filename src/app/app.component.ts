import { Component } from '@angular/core';
import { FormControl } from '@angular/forms';
import { Observable } from  "rxjs/Rx";
import 'rxjs/add/operator/filter';
import 'rxjs/add/operator/debounceTime';
import 'rxjs/add/operator/distinctUntilChanged';
import 'rxjs/add/operator/switchMap';

import { MdDialog, MdDialogRef, MdSnackBar } from '@angular/material';

import { ElasticsearchService } from './services';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent {
  title = 'Malware Graph Analysis';
  query = new FormControl();
  total: number;
  results: {_index:string, _id: string, _type: string, _source: Object, highlight: Object};

  constructor(
    private elasticsearchService: ElasticsearchService
  ) { }

  
  ngOnInit() {
    this.query.valueChanges
      .debounceTime(400)
      .distinctUntilChanged()
      .do(query => {
        if (query.length == 0) {
          this.total = undefined;
        }
      })
      .filter(query => query.length > 0)
      .switchMap(query => this.elasticsearchService.search(query))
      .subscribe(res => {
        console.log(res);
        this.total = res['total'];
        this.results = res['hits'];
        // this.results.map(res => res['except'])
      },
      error =>  console.log('incorrect search query'))
  }
}
